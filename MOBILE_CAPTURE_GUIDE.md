# 📱 모바일 자동 촬영 가이드

## 개요
이 시스템은 휴대폰으로 의류를 촬영하고, 노트북에서 자동으로 치수를 측정할 수 있는 기능을 제공합니다.

## 🎯 주요 특징

### 1. **자동 가이드 촬영**
조건이 모두 충족되면 자동으로 촬영이 진행됩니다.

### 2. **실시간 연동**
휴대폰에서 촬영한 이미지가 즉시 노트북으로 전송됩니다.

### 3. **조건 기반 촬영**
다음 세 가지 조건이 모두 충족되어야 촬영됩니다:
- ✅ **각도 조건**: 휴대폰이 바닥과 평행 (수직 촬영)
- ✅ **환경 조건**: 적절한 밝기 (조도 확보)
- ✅ **객체 조건**: A4 용지와 의류가 화면 안에 완전히 보임

---

## 📋 사용 방법

### 1️⃣ **서버 시작**
노트북에서 API 서버를 실행합니다:

```bash
# Windows
cd project/my-app
start_server.bat

# Mac/Linux
cd project/my-app
./start_server.sh
```

또는 직접 실행:
```bash
python api_server.py
```

### 2️⃣ **노트북에서 index.html 열기**
브라우저에서 `index.html`을 엽니다:
```
http://localhost:8000/index.html
```
또는 파일을 직접 열어도 됩니다.

### 3️⃣ **모드 선택**
- **직접 촬영**: 노트북 카메라로 직접 촬영
- **모바일 연동**: 휴대폰으로 QR 코드를 스캔하여 촬영

### 4️⃣ **QR 코드 스캔**
"모바일 연동" 버튼을 클릭하면 QR 코드가 표시됩니다.
휴대폰 카메라로 QR 코드를 스캔합니다.

### 5️⃣ **자동 촬영**
휴대폰 화면에 다음과 같이 표시됩니다:

```
📐 카메라 각도 확인 중...
💡 조명 확인 중...
📄 A4 및 의류 감지 중...
```

**모든 조건이 충족되면:**
```
✓ 카메라 각도 적합
✓ 조명 적합
✓ A4 및 의류 감지됨

3... 2... 1... [자동 촬영]
```

### 6️⃣ **자동 측정**
촬영된 이미지가 노트북으로 전송되고, 자동으로 측정 페이지(`demo_with_keypoints.html`)로 이동합니다.

---

## 📸 촬영 조건 상세

### 🔲 **각도 조건** (원근 왜곡 최소화)
- 휴대폰을 바닥과 **완벽하게 평행**하게 유지
- 기울기 허용 범위: ±15도 이내
- 화면이 수직으로 바닥을 향해야 함

**올바른 자세:**
```
     [휴대폰]
     =========  ← 평행
     
     [A4]
     [의류]
     =========
       바닥
```

**잘못된 자세:**
```
      [휴대폰]
     /         ← 기울어짐 (X)
    /
   [A4]
   [의류]
```

### 💡 **환경 조건** (밝기)
- **적절한 조명**: 너무 밝거나 어둡지 않아야 함
- **균일한 조명**: 그림자가 최소화되어야 함
- 평균 밝기: 80~220 (0~255 범위)
- 윤곽선이 명확히 보이는 정도

**권장 환경:**
- 실내 조명 또는 자연광
- 직사광선 피하기
- 그림자 최소화

### 📄 **객체/구도 조건**
- **A4 용지**와 **의류** 모두 화면 안에 완전히 보여야 함
- 잘리거나 겹치지 않아야 함
- A4는 의류 **위쪽**에 배치 (첨부하신 이미지 참고)

**올바른 배치:**
```
┌─────────────────┐
│                 │
│     [A4]        │
│                 │
│   [===의류===]  │
│   [=========]   │
│   [=========]   │
│                 │
└─────────────────┘
```

---

## 🔧 작동 원리

### 1. **WebSocket 연결**
```
노트북 (데스크톱)  ←→  API 서버  ←→  휴대폰 (모바일)
```

### 2. **세션 관리**
- 각 QR 코드는 고유한 세션 ID를 가짐
- 세션 ID로 노트북과 휴대폰을 연결

### 3. **실시간 조건 검사**
휴대폰에서 초당 30~60회 프레임 분석:
- 디바이스 센서로 각도 측정
- 이미지 밝기 분석
- 엣지 검출로 객체 감지

### 4. **안정성 확보**
- 최근 10프레임 중 8프레임 이상 조건 충족 시 안정적으로 판단
- 안정적인 상태에서 3초 카운트다운 후 촬영

### 5. **이미지 전송**
- 촬영된 이미지를 Base64로 인코딩
- WebSocket으로 실시간 전송
- 노트북의 localStorage에 임시 저장
- 측정 페이지로 자동 이동

---

## 🛠️ 기술 스택

### 백엔드
- **FastAPI**: REST API 및 WebSocket 서버
- **WebSocket**: 실시간 양방향 통신
- **Python**: 서버 로직

### 프론트엔드
- **HTML5/CSS3/JavaScript**: 웹 인터페이스
- **QRCode.js**: QR 코드 생성
- **WebRTC API**: 카메라 액세스
- **DeviceOrientation API**: 기기 각도 감지
- **Canvas API**: 이미지 처리 및 분석

---

## ⚠️ 문제 해결

### 1. **QR 코드가 생성되지 않음**
- API 서버가 실행 중인지 확인
- 브라우저 콘솔에서 오류 확인
- 방화벽 설정 확인

### 2. **카메라 접근 권한 오류**
- 휴대폰 설정에서 브라우저에 카메라 권한 부여
- HTTPS 또는 localhost에서만 작동 (보안 제약)

### 3. **각도 조건이 충족되지 않음**
- 휴대폰을 더 평평하게 유지
- 센서 보정이 필요할 수 있음 (휴대폰 재시작)

### 4. **밝기 조건이 충족되지 않음**
- 조명을 추가하거나 조정
- 창가로 이동 (자연광 활용)
- 직사광선 피하기

### 5. **객체 조건이 충족되지 않음**
- 카메라와 의류의 거리 조정
- A4와 의류가 화면에 완전히 보이도록 조정
- 배경과 대비가 명확하도록 배치

### 6. **WebSocket 연결 오류**
- 노트북과 휴대폰이 **같은 WiFi 네트워크**에 연결되어 있는지 확인
- `localhost` 대신 노트북의 IP 주소 사용 필요 시:
  - `index.html`에서 `http://localhost:8000` → `http://[노트북IP]:8000` 수정

---

## 📊 성능 최적화

### 프레임 분석
- 샘플링 기법으로 분석 속도 향상
- 전체 픽셀이 아닌 일부만 분석

### 안정성
- 히스토리 기반 조건 판단
- 순간적인 오류 무시

### 네트워크
- 이미지 압축 (JPEG, 품질 95%)
- WebSocket으로 실시간 전송

---

## 🔒 보안 고려사항

- 세션 ID는 짧은 시간만 유효
- 연결 종료 시 세션 자동 삭제
- 이미지는 localStorage에 임시 저장 후 즉시 삭제
- CORS 설정으로 외부 접근 제한

---

## 📝 추가 개선 가능 사항

1. **HTTPS 지원**: 외부 네트워크에서도 사용 가능
2. **클라우드 저장**: 임시 저장소 대신 클라우드 사용
3. **다중 촬영**: 여러 장 촬영 후 최적 이미지 선택
4. **AI 보정**: 각도/조명 자동 보정
5. **촬영 가이드 오버레이**: AR 가이드 표시

---

## 💡 사용 팁

1. **안정된 자세 유지**: 휴대폰을 흔들리지 않게 잡으세요
2. **충분한 높이**: 의류와 A4가 모두 보이도록 충분한 높이에서 촬영
3. **배경 단순화**: 무늬가 없는 단순한 배경 사용
4. **여러 번 시도**: 조건이 충족되지 않으면 각도/조명 조정 후 재시도
5. **네트워크 확인**: 노트북과 휴대폰이 같은 WiFi에 연결되어 있는지 확인

---

## 🎉 완료!

이제 휴대폰으로 간편하게 의류를 촬영하고, 노트북에서 자동으로 치수를 측정할 수 있습니다!

문제가 발생하면 위의 문제 해결 섹션을 참고하거나, API 서버 로그를 확인하세요.

